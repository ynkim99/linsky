<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="app.labs.linksy.DAO.FeedRepository">
    <resultMap id="feedResultMap" type="Feed">
        <result property="feedId" column="FEED_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="feedContent" column="FEED_CONTENT"/>
        <result property="feedTime" column="FEED_TIME"/>
        <result property="likeAmount" column="LIKE_AMOUNT"/>

        <association property="member" javaType="app.labs.linksy.Model.Member">
            <result property="userNickname" column="USER_NICKNAME"/>
            <result property="userImg" column="USER_IMG"/>
        </association>
    </resultMap>
	
	<!-- 피드와 관련된 데이터 ���회 -->
    <select id="getFeedsWithDetails" resultMap="feedResultMap">
        SELECT 
            f.feed_id, 
            f.user_id, 
            f.feed_content, 
            f.feed_time, 
            f.like_amount, 
            m.user_nickname,  
            m.user_img,
            i.img_name  
        FROM FEED f
        JOIN MEMBER m ON f.user_id = m.user_id
        LEFT JOIN FEED_IMAGE i ON f.feed_id = i.feed_id
    </select>
    
    <!-- 좋아요 추가 -->
    <insert id="addLike">
        INSERT INTO Feed_Like (user_feed_like_id, user_id, feed_id)
        VALUES (SEQ_FEED_LIKE.NEXTVAL, #{userId}, #{feedId})
    </insert>

    <!-- 좋아요 삭제 -->
    <delete id="removeLike">
        DELETE FROM Feed_Like
        WHERE user_id = #{userId} AND feed_id = #{feedId}
    </delete>

    <!-- 좋아요 개수 가져오기 -->
    <select id="getLikeAmount" resultType="int">
        SELECT COUNT(*)
        FROM Feed_Like
        WHERE feed_id = #{feedId}
    </select>
    
    <!-- 좋아요 목록 가져오기 -->
    <select id="getFeedLikes" resultType="java.util.Map">
        SELECT m.user_nickname, m.user_img
        FROM Feed_Like fl
        JOIN Member m ON fl.user_id = m.user_id
        WHERE fl.feed_id = #{feedId}
    </select>

</mapper>